<!DOCTYPE html>
<html lang="en" class="{% block html_class %}{% endblock %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}LPxGP{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#0f172a">

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        navy: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        },
                        gold: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#d4a84b',
                            600: '#b8860b',
                            700: '#92400e',
                            DEFAULT: '#d4a84b',
                        },
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- HTMX (CDN) -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Custom styles -->
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100%;
        }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Dark mode variables */
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
        }
        .dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }

        /* Common component styles */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .dark .card {
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .btn-primary {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .dark .btn-primary {
            background: linear-gradient(135deg, #d4a84b 0%, #b8860b 100%);
            color: #0f172a;
        }
        .btn-primary:hover {
            box-shadow: 0 0 0 3px rgba(212, 168, 75, 0.3);
        }
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
        }
        .form-input {
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.625rem 0.875rem;
            font-size: 0.875rem;
            width: 100%;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .form-input:focus {
            outline: none;
            border-color: #d4a84b;
            box-shadow: 0 0 0 3px rgba(212, 168, 75, 0.15);
        }
        .form-input.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15);
        }
        .form-error {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* HTMX loading indicator */
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
        .htmx-indicator {
            display: none;
        }

        /* Loading skeleton animation */
        .skeleton {
            background: linear-gradient(90deg, var(--border-color) 25%, var(--bg-primary) 50%, var(--border-color) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 0.375rem;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Spinner */
        .spinner {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid var(--border-color);
            border-top-color: #d4a84b;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
            max-height: 100vh;
            overflow-y: auto;
        }
        .toast {
            pointer-events: auto;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            max-width: 24rem;
            animation: toast-in 0.3s ease-out;
        }
        .toast.toast-out {
            animation: toast-out 0.3s ease-in forwards;
        }
        @keyframes toast-in {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes toast-out {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        .toast-success { background: #10b981; color: white; }
        .toast-error { background: #ef4444; color: white; }
        .toast-warning { background: #f59e0b; color: white; }
        .toast-info { background: #3b82f6; color: white; }

        /* Print styles */
        @media print {
            header, footer, .no-print, .toast-container { display: none !important; }
            body { background: white !important; }
            .card { box-shadow: none; border: 1px solid #ccc; }
            a { text-decoration: none; color: inherit; }
            @page { margin: 2cm; }
        }

        /* Keyboard shortcut hints */
        .kbd {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.5rem;
            height: 1.5rem;
            padding: 0 0.375rem;
            font-size: 0.75rem;
            font-family: monospace;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            box-shadow: 0 1px 0 var(--border-color);
        }

        /* Table sorting indicators */
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background: rgba(212, 168, 75, 0.1); }
        .sort-asc::after { content: ' ▲'; font-size: 0.625rem; }
        .sort-desc::after { content: ' ▼'; font-size: 0.625rem; }

        /* Collapsible sidebar */
        .sidebar-collapsed .sidebar-text { display: none; }
        .sidebar-collapsed .sidebar { width: 4rem; }
    </style>

    {% block head %}{% endblock %}
</head>
<body class="bg-navy-50 dark:bg-navy-900 text-navy-900 dark:text-navy-100 transition-colors duration-200">
    <!-- Toast container -->
    <div id="toast-container" class="toast-container"></div>

    {% block body %}
    <!-- Header -->
    <header class="bg-white dark:bg-navy-800 border-b border-navy-200 dark:border-navy-700 sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="flex items-center">
                        <span class="text-xl font-bold text-navy-900 dark:text-white">LP<span class="text-gold">x</span>GP</span>
                    </a>
                    {% block nav %}{% endblock %}
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Dark mode toggle -->
                    <button id="theme-toggle" onclick="toggleDarkMode()"
                            class="p-2 rounded-lg text-navy-600 dark:text-navy-300 hover:bg-navy-100 dark:hover:bg-navy-700"
                            aria-label="Toggle dark mode" title="Toggle dark mode (Ctrl+D)">
                        <svg id="theme-icon-light" class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                        <svg id="theme-icon-dark" class="w-5 h-5 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                        </svg>
                    </button>
                    {% block header_right %}
                    <a href="/login" class="inline-flex items-center px-4 py-2 bg-gold text-navy-900 font-semibold text-sm rounded-lg hover:bg-gold-400 transition-all shadow-sm hover:shadow-md">
                        Sign In
                        <svg class="w-4 h-4 ml-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                        </svg>
                    </a>
                    {% endblock %}
                    <!-- Mobile menu button -->
                    <button id="mobile-menu-button"
                            class="md:hidden p-2 rounded-lg text-navy-600 dark:text-navy-300 hover:text-navy-900 hover:bg-navy-100 dark:hover:bg-navy-700"
                            aria-label="Open navigation menu"
                            aria-expanded="false"
                            onclick="toggleMobileMenu()">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile navigation menu -->
        <div id="mobile-menu" class="hidden md:hidden border-t border-navy-200 dark:border-navy-700 bg-white dark:bg-navy-800">
            <nav class="px-4 py-3 space-y-2">
                {% block mobile_nav %}
                <a href="/matches" class="block py-2 px-3 rounded-lg text-navy-600 dark:text-navy-300 hover:bg-navy-100 dark:hover:bg-navy-700">Matches</a>
                <a href="/funds" class="block py-2 px-3 rounded-lg text-navy-600 dark:text-navy-300 hover:bg-navy-100 dark:hover:bg-navy-700">Funds</a>
                <a href="/lps" class="block py-2 px-3 rounded-lg text-navy-600 dark:text-navy-300 hover:bg-navy-100 dark:hover:bg-navy-700">LPs</a>
                {% endblock %}
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-white dark:bg-navy-800 border-t border-navy-200 dark:border-navy-700 mt-auto no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="text-sm text-navy-500 dark:text-navy-400">
                    &copy; 2025 LPxGP. All rights reserved.
                </div>
                <div class="flex items-center gap-4 text-xs text-navy-400 dark:text-navy-500">
                    <span class="hidden sm:inline">Keyboard shortcuts:</span>
                    <span><kbd class="kbd">/</kbd> Search</span>
                    <span><kbd class="kbd">j</kbd>/<kbd class="kbd">k</kbd> Navigate</span>
                    <span><kbd class="kbd">?</kbd> Help</span>
                </div>
            </div>
        </div>
    </footer>
    {% endblock %}

    <script>
    // ============================================
    // Mobile Menu Toggle
    // ============================================
    function toggleMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        const button = document.getElementById('mobile-menu-button');
        const isHidden = menu.classList.contains('hidden');

        if (isHidden) {
            menu.classList.remove('hidden');
            button.setAttribute('aria-expanded', 'true');
        } else {
            menu.classList.add('hidden');
            button.setAttribute('aria-expanded', 'false');
        }
    }

    // ============================================
    // Dark Mode Toggle
    // ============================================
    function initDarkMode() {
        const stored = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (stored === 'dark' || (!stored && prefersDark)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    }

    function toggleDarkMode() {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        showToast(isDark ? 'Dark mode enabled' : 'Light mode enabled', 'info');
    }

    // Initialize on load
    initDarkMode();

    // ============================================
    // Toast Notifications
    // ============================================
    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;

        const icons = {
            success: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
            error: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',
            warning: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
            info: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
        };

        toast.innerHTML = `${icons[type] || icons.info}<span>${message}</span>`;
        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('toast-out');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    // Global toast function for HTMX events
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        const xhr = evt.detail.xhr;
        if (xhr.status >= 200 && xhr.status < 300) {
            const msg = xhr.getResponseHeader('X-Toast-Message');
            const type = xhr.getResponseHeader('X-Toast-Type') || 'success';
            if (msg) showToast(msg, type);
        } else if (xhr.status >= 400) {
            showToast('Request failed. Please try again.', 'error');
        }
    });

    // ============================================
    // Keyboard Shortcuts
    // ============================================
    const keyboardShortcuts = {
        '/': () => {
            const searchInput = document.querySelector('input[type="search"], input[name="q"], input[placeholder*="Search"]');
            if (searchInput) {
                searchInput.focus();
                return true;
            }
        },
        'j': () => navigateList(1),
        'k': () => navigateList(-1),
        'Escape': () => {
            // Close any open modals
            const modal = document.querySelector('[data-modal].open, .modal.open');
            if (modal) {
                modal.classList.remove('open');
                modal.classList.add('hidden');
                return true;
            }
            // Blur focused input
            if (document.activeElement && document.activeElement.tagName === 'INPUT') {
                document.activeElement.blur();
                return true;
            }
        },
        '?': () => showKeyboardHelp(),
        'd': (e) => {
            if (e.ctrlKey || e.metaKey) {
                toggleDarkMode();
                return true;
            }
        },
        'Enter': () => {
            const focusedRow = document.querySelector('tr.focused, .list-item.focused');
            if (focusedRow) {
                const link = focusedRow.querySelector('a');
                if (link) {
                    link.click();
                    return true;
                }
            }
        }
    };

    let currentFocusIndex = -1;

    function navigateList(direction) {
        const rows = document.querySelectorAll('tbody tr[data-id], .list-item[data-id]');
        if (rows.length === 0) return;

        rows.forEach(r => r.classList.remove('focused', 'bg-gold/10'));
        currentFocusIndex = Math.max(0, Math.min(rows.length - 1, currentFocusIndex + direction));

        const targetRow = rows[currentFocusIndex];
        targetRow.classList.add('focused', 'bg-gold/10');
        targetRow.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }

    function showKeyboardHelp() {
        showToast('Shortcuts: / Search, j/k Navigate, Enter Open, Esc Close, Ctrl+D Dark mode', 'info', 5000);
    }

    document.addEventListener('keydown', function(e) {
        // Don't trigger shortcuts when typing in inputs
        if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
            if (e.key === 'Escape') {
                e.target.blur();
            }
            return;
        }

        const handler = keyboardShortcuts[e.key];
        if (handler && handler(e)) {
            e.preventDefault();
        }
    });

    // ============================================
    // Table Sorting (Client-side)
    // ============================================
    function initTableSorting() {
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', function() {
                const table = this.closest('table');
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const colIndex = Array.from(this.parentNode.children).indexOf(this);
                const isAsc = this.classList.contains('sort-asc');

                // Reset all headers
                table.querySelectorAll('th').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));

                // Sort rows
                rows.sort((a, b) => {
                    const aVal = a.children[colIndex]?.textContent.trim() || '';
                    const bVal = b.children[colIndex]?.textContent.trim() || '';

                    // Try numeric comparison
                    const aNum = parseFloat(aVal.replace(/[^0-9.-]/g, ''));
                    const bNum = parseFloat(bVal.replace(/[^0-9.-]/g, ''));

                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return isAsc ? bNum - aNum : aNum - bNum;
                    }
                    return isAsc ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
                });

                // Update classes and DOM
                this.classList.add(isAsc ? 'sort-desc' : 'sort-asc');
                rows.forEach(row => tbody.appendChild(row));
            });
        });
    }

    // Initialize on load and after HTMX swaps
    document.addEventListener('DOMContentLoaded', initTableSorting);
    document.body.addEventListener('htmx:afterSwap', initTableSorting);

    // ============================================
    // Form Validation
    // ============================================
    function validateForm(form) {
        let isValid = true;
        form.querySelectorAll('[required]').forEach(input => {
            const error = input.parentNode.querySelector('.form-error');
            if (!input.value.trim()) {
                input.classList.add('error');
                if (!error) {
                    const errEl = document.createElement('div');
                    errEl.className = 'form-error';
                    errEl.textContent = 'This field is required';
                    input.parentNode.appendChild(errEl);
                }
                isValid = false;
            } else {
                input.classList.remove('error');
                if (error) error.remove();
            }
        });

        // Email validation
        form.querySelectorAll('input[type="email"]').forEach(input => {
            if (input.value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input.value)) {
                input.classList.add('error');
                const existing = input.parentNode.querySelector('.form-error');
                if (!existing) {
                    const errEl = document.createElement('div');
                    errEl.className = 'form-error';
                    errEl.textContent = 'Please enter a valid email address';
                    input.parentNode.appendChild(errEl);
                }
                isValid = false;
            }
        });

        return isValid;
    }

    // Auto-validate on submit
    document.addEventListener('submit', function(e) {
        const form = e.target;
        if (form.hasAttribute('data-validate') && !validateForm(form)) {
            e.preventDefault();
            showToast('Please fix the errors in the form', 'error');
        }
    });

    // Clear error on input
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('error')) {
            e.target.classList.remove('error');
            const error = e.target.parentNode.querySelector('.form-error');
            if (error) error.remove();
        }
    });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
