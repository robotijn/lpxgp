{% extends "base.html" %}

{% block title %}{{ lp.name }} - LP Detail - LPxGP{% endblock %}

{% block content %}
<main class="max-w-7xl mx-auto px-4 lg:px-6 py-6 lg:py-8">
    <!-- Breadcrumb -->
    <div class="flex items-center text-sm mb-6">
        <a href="/lps" class="text-slate-500 hover:text-slate-700">Search</a>
        <span class="mx-2 text-slate-300">/</span>
        <span class="text-slate-900">{{ lp.name }}</span>
    </div>

    <!-- LP Header -->
    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm mb-6">
        <div class="flex flex-col lg:flex-row justify-between items-start gap-4">
            <div class="flex items-start space-x-4">
                <div class="w-16 h-16 bg-slate-100 rounded-lg flex items-center justify-center">
                    <span class="text-xl font-bold text-slate-600">{{ lp.name[:2].upper() }}</span>
                </div>
                <div>
                    <h1 class="text-xl lg:text-2xl font-semibold text-slate-900">{{ lp.name }}</h1>
                    <p class="text-slate-500">{{ lp.full_name or lp.name }}</p>
                    <div class="flex items-center mt-2 space-x-4">
                        <span class="px-2 py-1 text-xs font-medium bg-blue-50 text-blue-700 rounded">{{ lp.lp_type or 'Institutional' }}</span>
                        <span class="text-sm text-slate-500">{{ lp.hq_city or 'Unknown' }}{% if lp.hq_country %}, {{ lp.hq_country }}{% endif %}</span>
                    </div>
                </div>
            </div>
            <div class="flex space-x-3">
                <button
                    hx-post="/api/shortlist/{{ lp.id }}/toggle"
                    hx-swap="outerHTML"
                    class="bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-lg font-medium hover:bg-slate-50 transition">
                    {% if lp.in_shortlist %}★ In Shortlist{% else %}+ Add to Shortlist{% endif %}
                </button>
                <a href="/pitch?lp_id={{ lp.id }}" class="bg-slate-900 text-white px-4 py-2 rounded-lg font-medium hover:bg-slate-800 transition">
                    Generate Pitch
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Overview -->
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                <h2 class="font-semibold text-slate-900 mb-4">Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="text-sm text-slate-500">Total AUM</label>
                        <p class="text-xl font-semibold text-slate-900">${{ "%.1f"|format(lp.total_aum_bn or 0) }}B</p>
                    </div>
                    <div>
                        <label class="text-sm text-slate-500">PE Allocation</label>
                        <p class="text-xl font-semibold text-slate-900">{{ lp.pe_allocation_pct or 0 }}%</p>
                    </div>
                    <div>
                        <label class="text-sm text-slate-500">Est. PE Commitment</label>
                        <p class="text-xl font-semibold text-slate-900">${{ "%.1f"|format((lp.total_aum_bn or 0) * (lp.pe_allocation_pct or 0) / 100) }}B</p>
                    </div>
                </div>
            </div>

            <!-- Investment Mandate -->
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                <h2 class="font-semibold text-slate-900 mb-4">Investment Mandate</h2>
                <p class="text-slate-600 leading-relaxed mb-4">
                    {{ lp.mandate_description or lp.name + ' maintains a diversified private equity portfolio with allocations across buyout, growth equity, and venture capital strategies.' }}
                </p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                    <div class="p-4 bg-slate-50 rounded-lg">
                        <label class="text-xs text-slate-500 uppercase tracking-wide">Target Return</label>
                        <p class="font-medium text-slate-900">{{ lp.target_return or 'Net IRR 10%+' }}</p>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg">
                        <label class="text-xs text-slate-500 uppercase tracking-wide">Preferred Check</label>
                        <p class="font-medium text-slate-900">${{ lp.check_size_min_mm or 50 }}M - ${{ lp.check_size_max_mm or 200 }}M</p>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg">
                        <label class="text-xs text-slate-500 uppercase tracking-wide">Geography</label>
                        <p class="font-medium text-slate-900">{{ lp.geo_preferences or 'North America, Europe' }}</p>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg">
                        <label class="text-xs text-slate-500 uppercase tracking-wide">Strategies</label>
                        <p class="font-medium text-slate-900">{{ lp.strategies|join(', ') if lp.strategies else 'Diversified' }}</p>
                    </div>
                </div>
            </div>

            <!-- Key Contacts -->
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                <h2 class="font-semibold text-slate-900 mb-4">Key Contacts</h2>
                <div class="divide-y divide-slate-100">
                    {% for contact in lp.contacts or [{'name': 'Investment Director', 'title': 'Private Equity Team'}] %}
                    <div class="py-4 flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center mr-3">
                                <span class="text-sm font-medium text-slate-600">{{ contact.name[:2].upper() if contact.name else 'ID' }}</span>
                            </div>
                            <div>
                                <p class="font-medium text-slate-900">{{ contact.name or 'Contact Name' }}</p>
                                <p class="text-sm text-slate-500">{{ contact.title or 'Investment Director' }}</p>
                            </div>
                        </div>
                        <button class="text-sm text-amber-600 hover:text-amber-700">View Profile →</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Match Score -->
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                <h2 class="font-semibold text-slate-900 mb-4">Match Score</h2>
                <div class="text-center mb-4">
                    <div class="inline-flex items-center justify-center w-20 h-20 rounded-full
                        {% if (lp.score or 85) >= 80 %}bg-green-50 text-green-700{% elif (lp.score or 85) >= 60 %}bg-amber-50 text-amber-700{% else %}bg-slate-50 text-slate-700{% endif %}
                        text-3xl font-bold">
                        {{ lp.score or 85 }}
                    </div>
                    <p class="text-sm {% if (lp.score or 85) >= 80 %}text-green-600{% elif (lp.score or 85) >= 60 %}text-amber-600{% else %}text-slate-600{% endif %} mt-2">
                        {% if (lp.score or 85) >= 80 %}Excellent Match{% elif (lp.score or 85) >= 60 %}Good Match{% else %}Moderate Match{% endif %}
                    </p>
                </div>
                <div class="space-y-3">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-slate-500">Strategy Alignment</span>
                        <span class="text-green-600 font-medium">Strong</span>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-slate-500">Size Fit</span>
                        <span class="text-green-600 font-medium">Good</span>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-slate-500">Geography</span>
                        <span class="text-green-600 font-medium">Match</span>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-slate-500">ESG Focus</span>
                        <span class="text-green-600 font-medium">Aligned</span>
                    </div>
                </div>
                <a href="/matches/{{ lp.id }}" class="block w-full text-center bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-lg mt-4 hover:bg-slate-50 transition text-sm">
                    Why This Score?
                </a>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                <h2 class="font-semibold text-slate-900 mb-4">Actions</h2>
                <div class="space-y-2">
                    <a href="/pitch?lp_id={{ lp.id }}" class="w-full text-left px-4 py-3 text-sm text-slate-600 hover:bg-slate-50 rounded-lg transition flex items-center block">
                        <svg class="w-4 h-4 mr-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Generate Email Draft
                    </a>
                    <button class="w-full text-left px-4 py-3 text-sm text-slate-600 hover:bg-slate-50 rounded-lg transition flex items-center">
                        <svg class="w-4 h-4 mr-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Create LP Summary
                    </button>
                    <button class="w-full text-left px-4 py-3 text-sm text-slate-600 hover:bg-slate-50 rounded-lg transition flex items-center">
                        <svg class="w-4 h-4 mr-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        Flag Data Issue
                    </button>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm" id="notes-section">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-semibold text-slate-900">Notes</h2>
                    <button onclick="toggleNoteForm()" class="text-sm text-gold hover:text-gold-600">+ Add Note</button>
                </div>

                <!-- Add Note Form (hidden by default) -->
                <div id="note-form" class="hidden mb-4">
                    <textarea id="note-input" class="form-input w-full h-24 resize-none" placeholder="Add a note about this LP..."></textarea>
                    <div class="flex justify-end space-x-2 mt-2">
                        <button onclick="toggleNoteForm()" class="btn-secondary text-sm px-3 py-1">Cancel</button>
                        <button onclick="saveNote()" class="btn-primary text-sm px-3 py-1">Save Note</button>
                    </div>
                </div>

                <!-- Notes List -->
                <div id="notes-list" class="space-y-3">
                    {% for note in lp.notes or [] %}
                    <div class="p-3 bg-slate-50 rounded-lg">
                        <p class="text-sm text-slate-700">{{ note.content }}</p>
                        <div class="flex items-center justify-between mt-2">
                            <span class="text-xs text-slate-400">{{ note.created_at or 'Just now' }}</span>
                            <button onclick="deleteNote('{{ note.id }}')" class="text-xs text-red-500 hover:text-red-600">Delete</button>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-sm text-slate-400 italic" id="no-notes-msg">No notes yet. Add a note to track your interactions.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Tags Section -->
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-semibold text-slate-900">Tags</h2>
                    <button onclick="showTagInput()" class="text-sm text-gold hover:text-gold-600">+ Add Tag</button>
                </div>

                <div id="tag-input-container" class="hidden mb-3">
                    <div class="flex space-x-2">
                        <input type="text" id="tag-input" class="form-input flex-1 text-sm" placeholder="Enter tag..." onkeypress="if(event.key==='Enter') addTag()">
                        <button onclick="addTag()" class="btn-primary text-sm px-3">Add</button>
                    </div>
                </div>

                <div id="tags-container" class="flex flex-wrap gap-2">
                    {% for tag in lp.tags or ['Priority', 'Tech Focus'] %}
                    <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-gold/10 text-gold rounded-full">
                        {{ tag }}
                        <button onclick="removeTag('{{ tag }}')" class="ml-1 hover:text-gold-600">&times;</button>
                    </span>
                    {% endfor %}
                </div>
            </div>

            <!-- Data Quality -->
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="font-semibold text-slate-900">Data Quality</h2>
                    <span class="px-2 py-0.5 text-xs bg-green-50 text-green-700 rounded">High</span>
                </div>
                <p class="text-sm text-slate-500">Last updated: {{ lp.updated_at or '2 weeks ago' }}</p>
            </div>
        </div>
    </div>
</main>

<script>
// Notes functionality
function toggleNoteForm() {
    const form = document.getElementById('note-form');
    form.classList.toggle('hidden');
    if (!form.classList.contains('hidden')) {
        document.getElementById('note-input').focus();
    }
}

function saveNote() {
    const input = document.getElementById('note-input');
    const content = input.value.trim();
    if (!content) return;

    // Add note to UI
    const notesList = document.getElementById('notes-list');
    const noNotesMsg = document.getElementById('no-notes-msg');
    if (noNotesMsg) noNotesMsg.remove();

    const noteHtml = `
        <div class="p-3 bg-slate-50 rounded-lg">
            <p class="text-sm text-slate-700">${content}</p>
            <div class="flex items-center justify-between mt-2">
                <span class="text-xs text-slate-400">Just now</span>
                <button onclick="this.closest('.p-3').remove()" class="text-xs text-red-500 hover:text-red-600">Delete</button>
            </div>
        </div>
    `;
    notesList.insertAdjacentHTML('afterbegin', noteHtml);

    input.value = '';
    toggleNoteForm();
    showToast('Note saved', 'success');
}

function deleteNote(id) {
    if (confirm('Delete this note?')) {
        showToast('Note deleted', 'success');
    }
}

// Tags functionality
function showTagInput() {
    const container = document.getElementById('tag-input-container');
    container.classList.toggle('hidden');
    if (!container.classList.contains('hidden')) {
        document.getElementById('tag-input').focus();
    }
}

function addTag() {
    const input = document.getElementById('tag-input');
    const tag = input.value.trim();
    if (!tag) return;

    const container = document.getElementById('tags-container');
    const tagHtml = `
        <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-gold/10 text-gold rounded-full">
            ${tag}
            <button onclick="this.parentElement.remove(); showToast('Tag removed', 'success')" class="ml-1 hover:text-gold-600">&times;</button>
        </span>
    `;
    container.insertAdjacentHTML('beforeend', tagHtml);

    input.value = '';
    document.getElementById('tag-input-container').classList.add('hidden');
    showToast('Tag added', 'success');
}

function removeTag(tag) {
    showToast('Tag removed', 'success');
}
</script>
{% endblock %}
